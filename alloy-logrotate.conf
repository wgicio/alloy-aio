# =============================================================================
# Logrotate Configuration for Grafana Alloy
# =============================================================================
#
# This configuration ensures that rotated log files maintain proper ACL
# permissions so Grafana Alloy can continue reading them.
#
# Installation:
#   sudo cp alloy-logrotate.conf /etc/logrotate.d/alloy-permissions
#
# This works by running a post-rotation script that reapplies ACL permissions
# to newly created log files after rotation.
# =============================================================================

# Apply to all log files in /var/log
/var/log/*.log {
    # Run after each log is rotated
    postrotate
        # Only run if alloy user exists and setfacl is available
        if id "alloy" >/dev/null 2>&1 && command -v setfacl >/dev/null 2>&1; then
            # Apply read permission to the new log file
            setfacl -m u:alloy:r "$1" 2>/dev/null || true
        fi
    endscript
    
    # Shared script runs once for all matched files
    sharedscripts
}

# Specific handling for syslog and messages (no .log extension)
/var/log/syslog /var/log/messages {
    postrotate
        if id "alloy" >/dev/null 2>&1 && command -v setfacl >/dev/null 2>&1; then
            setfacl -m u:alloy:r "$1" 2>/dev/null || true
        fi
    endscript
    sharedscripts
}
